// ------------------------------------------------------
// Datasource + Generator
// ------------------------------------------------------

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//////////////////////////////////////////////////////////
//  ATHLETE (CORE IDENTITY)
//////////////////////////////////////////////////////////

model Athlete {
  id           String   @id @default(cuid())

  // Auth
  firebaseId   String   @unique
  email        String?

  // Company Link (Single-tenant)
  companyId    String
  company      GoFastCompany @relation(fields: [companyId], references: [id])

  // Universal profile
  firstName    String?
  lastName     String?
  gofastHandle String?  @unique
  photoURL     String?
  phoneNumber  String?
  birthday     DateTime?
  gender       String?
  city         String?
  state        String?
  primarySport String?
  bio          String?
  instagram    String?

  // Training profile (future)
  myCurrentPace       String?
  myWeeklyMileage     Int?
  myTrainingGoal      String?
  myTrainingStartDate DateTime?
  myTargetRace        String?
  preferredDistance   String?
  myPaceRange         String?
  timePreference      String?
  myRunningGoals      String?

  // Garmin PKCE Integration
  garmin_user_id         String?  @unique
  garmin_access_token    String?
  garmin_refresh_token   String?
  garmin_expires_in      Int?
  garmin_scope           String?
  garmin_connected_at     DateTime?
  garmin_last_sync_at    DateTime?
  garmin_is_connected     Boolean  @default(false)
  garmin_disconnected_at  DateTime?
  garmin_permissions      Json?
  garmin_user_profile     Json?
  garmin_user_sleep       Json?
  garmin_user_preferences Json?

  // Strava (future)
  strava_id             Int?     @unique
  strava_access_token   String?
  strava_refresh_token  String?
  strava_expires_at     Int?

  // Relations
  activities           AthleteActivity[]
  runCrewMemberships   RunCrewMembership[]
  runCrewManagers      RunCrewManager[]
  runCrewMessages      RunCrewMessage[]
  runCrewAnnouncements RunCrewAnnouncement[]
  runCrewRuns          RunCrewRun[]
  runCrewRunRSVPs      RunCrewRunRSVP[]
  runCrewEvents        RunCrewEvent[]
  runCrewEventRSVPs    RunCrewEventRSVP[]

  // Training relations
  trainingPlans        TrainingPlan[]
  plannedDays          TrainingDayPlanned[]
  executedDays         TrainingDayExecuted[]
  createdRaces         Race[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////////////
//  ATHLETE ACTIVITIES (GARMIN)
//////////////////////////////////////////////////////////

model AthleteActivity {
  id              String   @id @default(cuid())
  athleteId       String
  sourceActivityId String  @unique
  source          String   @default("garmin")

  activityType   String?
  activityName   String?
  startTime      DateTime?
  duration       Int?
  distance       Float?
  calories       Int?
  averageSpeed   Float?
  averageHeartRate Int?
  maxHeartRate   Int?
  elevationGain  Float?
  steps          Int?

  // Location + Polyline
  startLatitude  Float?
  startLongitude Float?
  endLatitude    Float?
  endLongitude   Float?
  summaryPolyline String?

  summaryData    Json?
  detailData     Json?
  hydratedAt     DateTime?

  athlete Athlete @relation(fields:[athleteId], references:[id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////////////
//  RUNCREW — CORE MODELS
//////////////////////////////////////////////////////////

model RunCrew {
  id          String   @id @default(cuid())
  name        String
  description String?
  joinCode    String   @unique
  logo        String?
  icon        String?
  isArchived  Boolean  @default(false)
  archivedAt  DateTime?

  memberships   RunCrewMembership[]
  managers      RunCrewManager[]
  messages      RunCrewMessage[]
  announcements RunCrewAnnouncement[]
  runs          RunCrewRun[]
  events        RunCrewEvent[]
  joinCodes     JoinCode[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RunCrewMembership {
  id        String   @id @default(cuid())
  runCrewId String
  athleteId String
  joinedAt  DateTime @default(now())

  runCrew RunCrew @relation(fields:[runCrewId], references:[id])
  athlete Athlete @relation(fields:[athleteId], references:[id])

  createdAt DateTime @default(now())

  @@unique([runCrewId, athleteId])
}

model RunCrewManager {
  id        String   @id @default(cuid())
  runCrewId String
  athleteId String
  role      String   // "admin" | "manager"

  runCrew RunCrew @relation(fields:[runCrewId], references:[id])
  athlete Athlete @relation(fields:[athleteId], references:[id])

  createdAt DateTime @default(now())

  @@unique([runCrewId, athleteId])
}

//////////////////////////////////////////////////////////
//  RUNCREW SOCIAL
//////////////////////////////////////////////////////////

model RunCrewMessage {
  id         String   @id @default(cuid())
  runCrewId  String
  athleteId  String
  content    String

  runCrew RunCrew @relation(fields:[runCrewId], references:[id])
  athlete Athlete @relation(fields:[athleteId], references:[id])

  createdAt DateTime @default(now())
}

model RunCrewAnnouncement {
  id         String   @id @default(cuid())
  runCrewId  String
  authorId   String
  title      String
  content    String

  runCrew RunCrew @relation(fields:[runCrewId], references:[id])
  author  Athlete @relation(fields:[authorId], references:[id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////////////
//  RUNCREW RUNS + RSVPs
//////////////////////////////////////////////////////////

model RunCrewRun {
  id          String   @id @default(cuid())
  runCrewId   String
  createdById String

  title       String
  runType     String   @default("single")
  date        DateTime
  startTime   String
  timezone    String?
  meetUpPoint String
  meetUpAddress String?
  meetUpPlaceId String?
  meetUpLat   Float?
  meetUpLng   Float?

  recurrenceRule   String?
  recurrenceEndsOn DateTime?
  recurrenceNote   String?

  totalMiles  Float?
  pace        String?
  stravaMapUrl String?
  description String?

  runCrew   RunCrew @relation(fields:[runCrewId], references:[id])
  createdBy Athlete @relation(fields:[createdById], references:[id])

  rsvps RunCrewRunRSVP[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RunCrewRunRSVP {
  id        String   @id @default(cuid())
  runId     String
  athleteId String
  status    String   // "going" | "maybe" | "not-going"

  run     RunCrewRun @relation(fields:[runId], references:[id])
  athlete Athlete     @relation(fields:[athleteId], references:[id])

  createdAt DateTime @default(now())

  @@unique([runId, athleteId])
}

//////////////////////////////////////////////////////////
//  RUNCREW EVENTS + RSVPs
//////////////////////////////////////////////////////////

model RunCrewEvent {
  id         String   @id @default(cuid())
  runCrewId  String
  organizerId String

  title       String
  date        DateTime
  time        String
  location    String
  address     String?
  description String?
  eventType   String?

  runCrew   RunCrew @relation(fields:[runCrewId], references:[id])
  organizer Athlete @relation(fields:[organizerId], references:[id])

  rsvps RunCrewEventRSVP[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RunCrewEventRSVP {
  id        String   @id @default(cuid())
  eventId   String
  athleteId String
  status    String

  event   RunCrewEvent @relation(fields:[eventId], references:[id])
  athlete Athlete       @relation(fields:[athleteId], references:[id])

  createdAt DateTime @default(now())

  @@unique([eventId, athleteId])
}

//////////////////////////////////////////////////////////
//  AUTHORITATIVE INVITE CODES
//////////////////////////////////////////////////////////

model JoinCode {
  id        String   @id @default(cuid())
  code      String   @unique
  runCrewId String
  expiresAt DateTime?
  isActive  Boolean @default(true)

  runCrew RunCrew @relation(fields:[runCrewId], references:[id])

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////////
//  TRAINING — KEEPING IT (as requested)
//////////////////////////////////////////////////////////

model Race {
  id          String   @id @default(cuid())
  raceName    String
  raceType    String
  raceDate    DateTime
  location    String?
  distanceMiles Float
  registrationUrl String?
  description String?
  createdByAthleteId String?

  createdByAthlete Athlete? @relation(fields:[createdByAthleteId], references:[id])

  trainingPlans TrainingPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TrainingPlan {
  id                     String   @id @default(cuid())
  athleteId              String
  raceId                 String?  // Made optional to support existing plans without raceId

  trainingPlanName       String
  trainingPlanGoalTime   String
  trainingPlanGoalPace   String?
  trainingPlanBaseline5k String
  trainingPlanBaselineWeeklyMileage Int?
  trainingPlanStartDate  DateTime
  trainingPlanTotalWeeks Int

  trainingPlanAdaptive5kTime String?

  status                 String @default("draft")

  athlete Athlete @relation(fields:[athleteId], references:[id])
  race    Race?   @relation(fields:[raceId], references:[id])

  phases      TrainingPhase[]
  plannedDays TrainingDayPlanned[]
  executions  TrainingPlanExecution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TrainingPhase {
  id            String   @id @default(cuid())
  trainingPlanId String
  phaseName     String
  phaseIndex    Int
  startWeek     Int
  endWeek       Int
  metadata      Json?

  trainingPlan TrainingPlan @relation(fields:[trainingPlanId], references:[id])
  plannedDays  TrainingDayPlanned[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TrainingDayPlanned {
  id             String   @id @default(cuid())
  trainingPlanId String
  trainingPhaseId String?
  athleteId      String

  date     DateTime
  weekIndex Int
  dayIndex Int
  dayName  String?
  phase    String
  plannedData Json

  trainingPlan TrainingPlan @relation(fields:[trainingPlanId], references:[id])
  trainingPhase TrainingPhase? @relation(fields:[trainingPhaseId], references:[id])
  athlete       Athlete        @relation(fields:[athleteId], references:[id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([trainingPlanId, weekIndex, dayIndex])
}

model TrainingPlanExecution {
  id             String   @id @default(cuid())
  trainingPlanId String
  startedAt      DateTime
  status         String @default("active")

  trainingPlan TrainingPlan @relation(fields:[trainingPlanId], references:[id])
  executedDays TrainingDayExecuted[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TrainingDayExecuted {
  id           String   @id @default(cuid())
  executionId  String
  athleteId    String
  activityId   String? @unique

  weekIndex   Int
  dayIndex    Int
  date        DateTime
  plannedData Json?
  analysis    Json?
  feedback    Json?

  execution TrainingPlanExecution @relation(fields:[executionId], references:[id])
  athlete   Athlete              @relation(fields:[athleteId], references:[id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([executionId, date])
}

//////////////////////////////////////////////////////////
//  GOFAST COMPANY (SINGLE-TENANT CONTAINER)
//////////////////////////////////////////////////////////

model GoFastCompany {
  id           String      @id @default(cuid())
  name         String
  slug         String      @unique
  address      String?
  city         String?
  state        String?
  zip          String?
  domain       String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  athletes     Athlete[]
}
