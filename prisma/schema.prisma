generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum AthleteRole {
  USER          // Default - regular user
  CLUB_LEADER   // Club leader - can manage their RunClub's CityRuns
  AMBASSADOR    // Ambassador - can manage their RunClub's CityRuns (future)
}

model Athlete {
  id                      String                   @id
  firebaseId              String                   @unique
  email                   String?
  companyId               String
  firstName               String?
  lastName                String?
  gofastHandle            String?                  @unique
  photoURL                String?
  phoneNumber             String?
  birthday                DateTime?
  gender                  String?
  city                    String?
  state                   String?
  primarySport            String?
  bio                     String?
  instagram               String?
  garmin_user_id          String?                  @unique
  garmin_access_token     String?
  garmin_refresh_token    String?
  garmin_expires_in       Int?
  garmin_scope            String?
  garmin_connected_at     DateTime?
  garmin_last_sync_at     DateTime?
  garmin_is_connected     Boolean                  @default(false)
  garmin_disconnected_at  DateTime?
  garmin_permissions      Json?
  garmin_user_profile     Json?
  garmin_user_sleep       Json?
  garmin_user_preferences Json?
  strava_id               Int?                     @unique
  strava_access_token     String?
  strava_refresh_token    String?
  strava_expires_at       Int?
  fiveKPace               String?
  weeklyMileage           Int?
  role                    AthleteRole               @default(USER)
  runClubId               String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime
  go_fast_companies       go_fast_companies        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  runClub                 run_clubs?               @relation(fields: [runClubId], references: [id], onDelete: SetNull)
  ambassador_credits      ambassador_credits[]
  ambassador_payouts      ambassador_payouts[]
  athlete_activities      athlete_activities[]
  run_crew_announcements  run_crew_announcements[]
  run_crew_event_rsvps    run_crew_event_rsvps[]
  run_crew_events         run_crew_events[]
  run_crew_memberships    run_crew_memberships[]
  run_crew_messages       run_crew_messages[]
  city_run_rsvps          city_run_rsvps[]
  city_run_messages       city_run_messages[]
  city_run_checkins       city_run_checkins[]
  city_runs               city_runs[]
  training_days_executed  training_days_executed[]
  training_plans          training_plans[]
  workouts                workouts[]
}

model ambassador_credits {
  id              String           @id @default(cuid())
  athleteId       String
  cityRunRsvpId   String           @unique         // One credit per RSVP (RSVP going + photo)
  amountCents     Int              @default(1000)  // $10 per qualified run
  createdAt       DateTime         @default(now())
  Athlete         Athlete          @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  city_run_rsvps  city_run_rsvps   @relation(fields: [cityRunRsvpId], references: [id], onDelete: Cascade)

  @@index([athleteId])
  @@index([createdAt])
}

model ambassador_payouts {
  id               String    @id @default(cuid())
  athleteId        String
  processedAt      DateTime  // When Company paid (period end for credits)
  amountCents      Int
  companyPayoutId  String?   // FK/id from GoFast Company payouts table (if synced)
  createdAt        DateTime  @default(now())
  Athlete          Athlete   @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId])
  @@index([processedAt])
}

model ai_roles {
  id                   String                 @id
  name                 String
  content              String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  training_gen_prompts training_gen_prompts[]
}

model athlete_activities {
  id               String            @id
  athleteId        String
  sourceActivityId String            @unique
  source           String            @default("garmin")
  activityType     String?
  activityName     String?
  startTime        DateTime?
  duration         Int?
  distance         Float?
  calories         Int?
  averageSpeed     Float?
  averageHeartRate Int?
  maxHeartRate     Int?
  elevationGain    Float?
  steps            Int?
  startLatitude    Float?
  startLongitude   Float?
  endLatitude      Float?
  endLongitude     Float?
  summaryPolyline  String?
  summaryData      Json?
  detailData       Json?
  hydratedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
  Athlete          Athlete           @relation(fields: [athleteId], references: [id], onDelete: Cascade)
}

model cities {
  id        String   @id
  slug      String   @unique
  name      String
  state     String?
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([name])
  @@index([slug])
}

model go_fast_companies {
  id        String    @id
  name      String?
  slug      String?   @unique
  address   String?
  city      String?
  state     String?
  zip       String?
  domain    String?
  createdAt DateTime  @default(now())
  updatedAt DateTime
  Athlete   Athlete[]
}

model join_codes {
  id        String    @id
  code      String    @unique
  runCrewId String
  createdAt DateTime  @default(now())
  expiresAt DateTime?
  isActive  Boolean   @default(true)
  run_crews run_crews @relation(fields: [runCrewId], references: [id], onDelete: Cascade)
}

model must_haves {
  id                   String                 @id
  name                 String
  fields               Json
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  training_gen_prompts training_gen_prompts[]
}

model prompt_instructions {
  id                   String                @id
  promptId             String?
  title                String
  content              String
  order                Int                   @default(0)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime
  training_gen_prompts training_gen_prompts? @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@index([promptId, order])
}

model race_registry {
  id                      String                    @id
  name                    String
  raceType                String
  city                    String?
  state                   String?
  country                 String?                   @default("USA")
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  address                 String?
  ageMaximum              Int?
  ageMinimum              Int?
  averageHumidity         Int?
  averageTemperature      Int?
  cancellationReason      String?
  charityDescription      String?
  charityName             String?
  charitySupported        Boolean                   @default(false)
  charityUrl              String?
  courseMapUrl            String?
  courseProfile           Json?
  courseType              String?
  currentParticipants     Int?
  description             String?
  distanceKm              Float?
  distanceMiles           Float
  earlyBirdDeadline       DateTime?
  earlyBirdFee            Float?
  elevationGain           Float?
  elevationGainMeters     Float?
  endTime                 DateTime?
  finishLat               Float?
  finishLng               Float?
  finishLocation          String?
  isActive                Boolean                   @default(true)
  isCancelled             Boolean                   @default(false)
  isVirtual               Boolean                   @default(false)
  maxParticipants         Int?
  notes                   String?
  officialWebsiteUrl      String?
  organizerEmail          String?
  organizerName           String?
  organizerWebsite        String?
  raceDate                DateTime
  registrationCloseDate   DateTime?
  registrationFee         Float?
  registrationOpenDate    DateTime?
  registrationUrl         String?
  resultsUrl              String?
  slug                    String?                   @unique
  startLat                Float?
  startLng                Float?
  startLocation           String?
  startTime               DateTime?
  stravaSegmentUrl        String?
  surfaceType             String?
  tags                    String[]                  @default([])
  timezone                String?
  typicalWeather          String?
  run_crew_specific_races run_crew_specific_races[]
  run_crews               run_crews[]
  training_plans          training_plans[]

  @@index([charitySupported])
  @@index([city, state])
  @@index([isActive])
  @@index([raceDate])
  @@index([raceType])
  @@index([slug])
  @@index([tags])
}

model return_json_formats {
  id                   String                 @id
  name                 String
  schema               Json
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  example              Json?
  training_gen_prompts training_gen_prompts[]
}

model rule_set_items {
  id              String          @id
  topicId         String
  text            String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  rule_set_topics rule_set_topics @relation(fields: [topicId], references: [id])
}

model rule_set_topics {
  id             String           @id
  rulesetId      String
  name           String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  rule_set_items rule_set_items[]
  rule_sets      rule_sets        @relation(fields: [rulesetId], references: [id])
}

model rule_sets {
  id                   String                 @id
  name                 String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  rule_set_topics      rule_set_topics[]
  training_gen_prompts training_gen_prompts[]
}

model run_clubs {
  id        String   @id @default(uuid())
  slug      String   @unique
  name      String
  logoUrl   String?
  city      String?
  description String?
  websiteUrl String?
  instagramUrl String?
  stravaUrl String?
  syncedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  runs         city_runs[]
  clubLeaders  Athlete[]          // Reverse relation for Athlete.runClubId
  runSetups    city_run_setups[]  // Recurring series this club owns

  @@index([city])
  @@index([slug])
}

model run_crew_announcements {
  id         String    @id
  runCrewId  String
  authorId   String
  title      String
  content    String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  archivedAt DateTime? @db.Timestamp(6)
  Athlete    Athlete   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  run_crews  run_crews @relation(fields: [runCrewId], references: [id], onDelete: Cascade)
}

model run_crew_event_rsvps {
  id              String          @id
  eventId         String
  athleteId       String
  status          String
  createdAt       DateTime        @default(now())
  Athlete         Athlete         @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  run_crew_events run_crew_events @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, athleteId])
}

model run_crew_events {
  id                   String                 @id
  runCrewId            String
  organizerId          String
  title                String
  date                 DateTime
  time                 String
  address              String?
  description          String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  additionalDetails    String?
  cost                 Int?
  venue                String
  run_crew_event_rsvps run_crew_event_rsvps[]
  Athlete              Athlete                @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  run_crews            run_crews              @relation(fields: [runCrewId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([runCrewId])
}

model run_crew_memberships {
  id        String      @id
  runCrewId String
  athleteId String
  joinedAt  DateTime    @default(now())
  createdAt DateTime    @default(now())
  updatedAt DateTime
  role      RunCrewRole @default(member)
  Athlete   Athlete     @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  run_crews run_crews   @relation(fields: [runCrewId], references: [id], onDelete: Cascade)

  @@unique([runCrewId, athleteId])
  @@index([runCrewId, role])
}

model run_crew_messages {
  id        String    @id
  runCrewId String
  athleteId String
  content   String
  createdAt DateTime  @default(now())
  topic     String    @default("general")
  updatedAt DateTime
  Athlete   Athlete   @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  run_crews run_crews @relation(fields: [runCrewId], references: [id], onDelete: Cascade)
}

model city_run_checkins {
  id          String    @id
  runId       String
  athleteId   String
  checkedInAt DateTime  @default(now())
  runPhotoUrl String?   // athlete's photo from this run
  runShouts   String?   // post-run shout-out / comment
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  Athlete     Athlete   @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  city_runs   city_runs @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, athleteId])
  @@index([runId])
  @@index([athleteId])
  @@map("city_run_checkins")
}

model city_run_messages {
  id        String     @id
  runId     String
  athleteId String
  content   String
  topic     String     @default("general")
  createdAt DateTime   @default(now())
  updatedAt DateTime
  Athlete   Athlete    @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  city_runs city_runs  @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([athleteId])
  @@index([topic])
  @@map("city_run_messages")
}

model city_run_rsvps {
  id              String        @id
  runId           String
  athleteId       String
  status          String        // "going", "not-going", "maybe"
  occurrenceDate  DateTime?     // null = standalone run; set = recurring (the specific occurrence date)
  checkedInAt     DateTime?     // Timestamp when checked in (null = not checked in)
  rsvpPhotoUrls   Json?         // Photos attendee posted for this run (ambassador credit when going + â‰¥1 photo)
  createdAt       DateTime      @default(now())
  Athlete         Athlete       @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  city_runs       city_runs     @relation(fields: [runId], references: [id], onDelete: Cascade)
  ambassador_credits ambassador_credits?

  @@unique([runId, athleteId])
  @@index([checkedInAt])
  @@index([occurrenceDate])
}

model city_runs {
  id                  String               @id
  runCrewId           String?
  title               String
  date                DateTime
  timezone            String?
  meetUpPoint         String
  meetUpPlaceId       String?
  meetUpLat           Float?
  meetUpLng           Float?
  totalMiles          Float?
  pace                String?
  stravaMapUrl        String?
  description         String?
  postRunActivity     String?              // Post-run activity (e.g. "light social at X", "coffee at Y")
  routePhotos         Json?                // Array of photo URLs: ["url1", "url2", ...]
  mapImageUrl         String?              // Single map image URL (snip from Strava or uploaded)
  staffNotes          String?              // Data entry note for approver (e.g. "Couldn't get Strava URL")
  // Source inputs - capture ALL available sources for AI processing and traceability
  stravaUrl           String?              // Strava route/activity URL
  stravaText          String?              // Raw text blob from Strava (copy/paste)
  webUrl              String?              // Web/website URL
  webText             String?              // Raw text blob from web (copy/paste)
  igPostText          String?              // Instagram post text (copy/paste)
  igPostGraphic       String?              // Instagram post image URL (uploaded blob)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  startTimeHour       Int?
  startTimeMinute     Int?
  startTimePeriod     String?
  runClubId           String?
  athleteGeneratedId  String?
  staffGeneratedId    String?
  citySlug            String
  slug                String?              @unique // URL-friendly slug: "title-of-run" (generated from title)
  dayOfWeek           String?
  endDate             DateTime?
  workflowStatus      RunWorkflowStatus    @default(DEVELOP)
  startDate           DateTime
  endPoint            String?
  meetUpStreetAddress String?
  meetUpCity          String?
  meetUpState         String?
  meetUpZip           String?
  routeNeighborhood String?              // Neighborhood/area route goes through (e.g. "Arlington Heights", "Back Bay") - gives run flavor
  runType             String?              // Type of run location: "track", "trail", "neighborhood", "park"
  workoutDescription  String?              // Workout focus/description (e.g. "emphasizes speed training for those want to increase threshold")
  endStreetAddress    String?
  endCity             String?
  endState            String?
  cityRunSetupId      String?              // null = standalone; set = recurring (FK to city_run_setups)
  city_run_rsvps      city_run_rsvps[]
  city_run_messages   city_run_messages[]
  city_run_checkins   city_run_checkins[]
  Athlete             Athlete?             @relation(fields: [athleteGeneratedId], references: [id], onDelete: Cascade)
  run_crews           run_crews?           @relation(fields: [runCrewId], references: [id], onDelete: Cascade)
  runClub             run_clubs?           @relation(fields: [runClubId], references: [id], onDelete: SetNull)
  cityRunSetup        city_run_setups?     @relation(fields: [cityRunSetupId], references: [id], onDelete: SetNull)

  @@index([athleteGeneratedId])
  @@index([citySlug])
  @@index([slug])
  @@index([date])
  @@index([dayOfWeek])
  @@index([workflowStatus])
  @@index([runClubId])
  @@index([runCrewId])
  @@index([staffGeneratedId])
  @@index([startDate])
  @@index([cityRunSetupId])
  // Table name is city_runs (migrated from run_crew_runs). Explicit map so deployed builds never use old name.
  @@map("city_runs")
}

model city_run_setups {
  id         String      @id
  dayOfWeek  String      // "MONDAY" | "TUESDAY" | ... | "SUNDAY"
  runClubId  String?     // which club owns this recurring series
  name       String?     // optional series label, e.g. "Tuesday Tempo"
  createdAt  DateTime    @default(now())
  updatedAt  DateTime
  city_runs  city_runs[]
  runClub    run_clubs?  @relation(fields: [runClubId], references: [id], onDelete: SetNull)

  @@index([runClubId])
  @@map("city_run_setups")
}

model run_crew_specific_races {
  id             String        @id
  runCrewId      String
  raceRegistryId String
  createdAt      DateTime      @default(now())
  race_registry  race_registry @relation(fields: [raceRegistryId], references: [id], onDelete: Cascade)
  run_crews      run_crews     @relation(fields: [runCrewId], references: [id], onDelete: Cascade)

  @@unique([runCrewId, raceRegistryId])
}

model run_crews {
  id                      String                    @id
  name                    String
  description             String?
  joinCode                String                    @unique
  logo                    String?
  icon                    String?
  archivedAt              DateTime?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  messageTopics           Json?
  city                    String?
  ageMin                  Int?
  ageMax                  Int?
  primaryMeetUpPoint      String?
  primaryMeetUpAddress    String?
  primaryMeetUpPlaceId    String?
  primaryMeetUpLat        Float?
  primaryMeetUpLng        Float?
  gender                  Gender?
  state                   State?
  typicalRunMiles         Float?
  longRunMilesMin         Float?
  longRunMilesMax         Float?
  timePreference          TimePreference[]          @default([])
  purpose                 Purpose[]                 @default([])
  trainingForRace         String?
  trainingForDistance     TrainingForDistance[]     @default([])
  easyMilesPace           Int?
  crushingItPace          Int?
  handle                  String                    @unique
  join_codes              join_codes[]
  run_crew_announcements  run_crew_announcements[]
  run_crew_events         run_crew_events[]
  run_crew_memberships    run_crew_memberships[]
  run_crew_messages       run_crew_messages[]
  city_runs               city_runs[]
  run_crew_specific_races run_crew_specific_races[]
  race_registry           race_registry?            @relation(fields: [trainingForRace], references: [id])
}

model training_days_executed {
  id          String   @id
  athleteId   String
  activityId  String?  @unique
  weekIndex   Int
  dayIndex    Int
  date        DateTime
  plannedData Json?
  analysis    Json?
  feedback    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Athlete     Athlete  @relation(fields: [athleteId], references: [id])
}

model training_gen_prompts {
  id                  String                @id
  name                String
  description         String?
  aiRoleId            String
  ruleSetId           String?
  mustHavesId         String
  returnFormatId      String
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  prompt_instructions prompt_instructions[]
  ai_roles            ai_roles              @relation(fields: [aiRoleId], references: [id])
  must_haves          must_haves            @relation(fields: [mustHavesId], references: [id])
  return_json_formats return_json_formats   @relation(fields: [returnFormatId], references: [id])
  rule_sets           rule_sets?            @relation(fields: [ruleSetId], references: [id])
}

model training_plan_phases {
  id                     String                @id
  planId                 String
  name                   String
  weekCount              Int
  totalMiles             Float?
  phaseDescription       String?
  phaseTotalMilesTarget  Float?
  longRunProgression     Int[]                 @default([])
  qualityWorkoutsPerWeek Int                   @default(1)
  runTypesEnabled        Json?
  phaseStartDate         DateTime
  phaseEndDate           DateTime
  createdAt              DateTime              @default(now())
  updatedAt              DateTime
  training_plans         training_plans        @relation(fields: [planId], references: [id], onDelete: Cascade)
  training_plan_weeks    training_plan_weeks[]

  @@unique([planId, name])
}

model training_plan_weeks {
  id                   String               @id
  planId               String
  phaseId              String
  weekNumber           Int
  miles                Float?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime
  planningDays         Json?
  training_plan_phases training_plan_phases @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  training_plans       training_plans       @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, weekNumber])
}

model training_plans {
  id                   String                 @id
  athleteId            String
  raceId               String?
  name                 String
  goalTime             String?
  goalRacePace         Int?
  predictedRacePace    Int?
  current5KPace        String?
  currentWeeklyMileage Int?
  preferredDays        Int[]
  startDate            DateTime
  totalWeeks           Int
  goalPace5K           String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  training_plan_phases training_plan_phases[]
  training_plan_weeks  training_plan_weeks[]
  Athlete              Athlete                @relation(fields: [athleteId], references: [id])
  race_registry        race_registry?         @relation(fields: [raceId], references: [id])
}

model training_schemas {
  id          String   @id
  name        String   @unique
  description String?
  schemaJson  Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model workouts {
  id             String         @id
  title          String
  workoutType    WorkoutType
  description    String?
  workoutFormat  WorkoutFormat?
  totalMiles     Float?
  warmUpMiles    Float?
  mainSetMiles   Float?
  coolDownMiles  Float?
  effortType     EffortType?
  effortModifier Float?
  athleteId      String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  Athlete        Athlete        @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId])
  @@index([workoutType])
}

enum EffortType {
  Easy
  MarathonEffort
  HalfMarathonEffort
  TenKEffort
  FiveKEffort
  RPE
}

enum Gender {
  male
  female
  both
}

enum Purpose {
  Training
  Fun
  Social
}

enum RunCrewRole {
  member
  admin
  manager
}

enum State {
  AL
  AK
  AZ
  AR
  CA
  CO
  CT
  DE
  DC
  FL
  GA
  HI
  ID
  IL
  IN
  IA
  KS
  KY
  LA
  ME
  MD
  MA
  MI
  MN
  MS
  MO
  MT
  NE
  NV
  NH
  NJ
  NM
  NY
  NC
  ND
  OH
  OK
  OR
  PA
  RI
  SC
  SD
  TN
  TX
  UT
  VT
  VA
  WA
  WV
  WI
  WY
}

enum TimePreference {
  Morning
  Afternoon
  Evening
}

enum TrainingForDistance {
  FiveK
  TenK
  HalfMarathon
  Marathon
  Ultra
}

enum WorkoutFormat {
  Continuous
  WarmupMainCooldown
  Progression
  IntervalsUnstructured
}

enum WorkoutType {
  Easy
  Tempo
  Intervals
  LongRun
  Speed
  Strength
}

enum RunWorkflowStatus {
  DEVELOP
  PENDING
  SUBMITTED
  APPROVED
}
