generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model Athlete {
  id                      String                   @id @default(cuid())
  firebaseId              String                   @unique
  email                   String?
  companyId               String
  firstName               String?
  lastName                String?
  gofastHandle            String?                  @unique
  photoURL                String?
  phoneNumber             String?
  birthday                DateTime?
  gender                  String?
  city                    String?
  state                   String?
  primarySport            String?
  bio                     String?
  instagram               String?
  garmin_user_id          String?                  @unique
  garmin_access_token     String?
  garmin_refresh_token    String?
  garmin_expires_in       Int?
  garmin_scope            String?
  garmin_connected_at     DateTime?
  garmin_last_sync_at     DateTime?
  garmin_is_connected     Boolean                  @default(false)
  garmin_disconnected_at  DateTime?
  garmin_permissions      Json?
  garmin_user_profile     Json?
  garmin_user_sleep       Json?
  garmin_user_preferences Json?
  strava_id               Int?                     @unique
  strava_access_token     String?
  strava_refresh_token    String?
  strava_expires_at       Int?
  fiveKPace               String?
  weeklyMileage           Int?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  goFastCompany           GoFastCompany            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  athlete_activities      athlete_activities[]
  run_crew_announcements  run_crew_announcements[]
  run_crew_event_rsvps    run_crew_event_rsvps[]
  run_crew_events         run_crew_events[]
  run_crew_memberships    run_crew_memberships[]
  run_crew_messages       run_crew_messages[]
  run_crew_run_rsvps      run_crew_run_rsvps[]
  city_runs               city_runs[]
  training_days_executed  training_days_executed[]
  training_plans          training_plans[]
  workouts                Workout[]
}

model ai_roles {
  id                   String                 @id
  name                 String
  content              String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  training_gen_prompts training_gen_prompts[]
}

model athlete_activities {
  id               String    @id
  athleteId        String
  sourceActivityId String    @unique
  source           String    @default("garmin")
  activityType     String?
  activityName     String?
  startTime        DateTime?
  duration         Int?
  distance         Float?
  calories         Int?
  averageSpeed     Float?
  averageHeartRate Int?
  maxHeartRate     Int?
  elevationGain    Float?
  steps            Int?
  startLatitude    Float?
  startLongitude   Float?
  endLatitude      Float?
  endLongitude     Float?
  summaryPolyline  String?
  summaryData      Json?
  detailData       Json?
  hydratedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
  Athlete          Athlete   @relation(fields: [athleteId], references: [id], onDelete: Cascade)
}

model GoFastCompany {
  id        String    @id @default(cuid())
  name      String?
  slug      String?   @unique
  address   String?
  city      String?
  state     String?
  zip       String?
  domain    String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Athlete   Athlete[]

  @@map("go_fast_companies")
}

model join_codes {
  id        String    @id
  code      String    @unique
  runCrewId String
  createdAt DateTime  @default(now())
  expiresAt DateTime?
  isActive  Boolean   @default(true)
  run_crews run_crews @relation(fields: [runCrewId], references: [id], onDelete: Cascade)
}

model must_haves {
  id                   String                 @id
  name                 String
  fields               Json
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  training_gen_prompts training_gen_prompts[]
}

model prompt_instructions {
  id                   String                @id
  promptId             String?
  title                String
  content              String
  order                Int                   @default(0)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime
  training_gen_prompts training_gen_prompts? @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@index([promptId, order])
}

// Unified Race Model - The spine for all race-related functionality
// Curated race data (not dependent on external APIs like RunSignup)
// Use registrationUrl as referral link to external registration platforms
model race_registry {
  id String @id @default(cuid())

  // Basic Identity
  name          String
  slug          String? @unique // URL-friendly: "boston-marathon-2025"
  description   String?
  raceType      String // e.g., "5k", "10k", "10m", "half", "marathon", "ultra", "other"
  distanceMiles Float // Exact distance in miles
  distanceKm    Float? // Exact distance in kilometers

  // Date & Time
  raceDate                DateTime // Race date
  startTime             DateTime? // Actual start time (e.g., "2025-04-21T09:00:00Z")
  endTime               DateTime? // Expected end time (for cutoff)
  timezone              String? // e.g., "America/New_York"
  registrationOpenDate  DateTime? // When registration opens
  registrationCloseDate DateTime? // When registration closes

  // Location
  city           String?
  state          String?
  country        String? @default("USA")
  address        String? // Full address
  startLocation  String? // Start line location name
  finishLocation String? // Finish line location name
  startLat       Float?
  startLng       Float?
  finishLat      Float?
  finishLng      Float?

  // Registration & Links
  registrationUrl    String? // Referral link to registration (RunSignup, Active.com, race website, etc.)
  officialWebsiteUrl String? // Race official website
  resultsUrl         String? // Link to results (post-race)
  courseMapUrl       String? // Course map link
  stravaSegmentUrl   String? // Strava segment link

  // Course Information
  elevationGain       Float? // Elevation gain in feet
  elevationGainMeters Float? // Elevation gain in meters
  surfaceType         String? // "road", "trail", "track", "mixed"
  courseType          String? // "loop", "point-to-point", "out-and-back"
  courseProfile       Json? // Detailed course data (elevation profile, etc.)

  // Weather & Climate
  typicalWeather     String? // "cool", "hot", "variable"
  averageTemperature Int? // Average temp in Fahrenheit
  averageHumidity    Int? // Average humidity percentage

  // Charity & Cause
  charitySupported   Boolean @default(false)
  charityName        String? // Name of charity/cause
  charityUrl         String? // Link to charity
  charityDescription String? // Description of cause

  // Organization
  organizerName    String? // Race organizer name
  organizerEmail   String? // Contact email
  organizerWebsite String? // Organizer website

  // Pricing (optional)
  registrationFee   Float? // Registration fee in USD
  earlyBirdFee      Float? // Early bird pricing
  earlyBirdDeadline DateTime? // Early bird deadline

  // Capacity & Limits
  maxParticipants     Int? // Maximum participants
  currentParticipants Int? // Current registrations (if tracked)
  ageMinimum          Int? // Minimum age requirement
  ageMaximum          Int? // Maximum age requirement

  // Status & Flags
  isActive           Boolean @default(true)
  isVirtual          Boolean @default(false)
  isCancelled        Boolean @default(false)
  cancellationReason String? // Why cancelled

  // Metadata
  tags  String[] @default([]) // e.g., ["boston", "marathon", "qualifying"]
  notes String? // Internal notes

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  training_plans          training_plans[]
  run_crew_specific_races run_crew_specific_races[]
  run_crews_training_for  run_crews[]               @relation("TrainingForRace")

  @@index([raceDate])
  @@index([city, state])
  @@index([raceType])
  @@index([slug])
  @@index([isActive])
  @@index([charitySupported])
  @@index([tags])
  @@map("race_registry")
}

model return_json_formats {
  id                   String                 @id
  name                 String
  schema               Json
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  example              Json?
  training_gen_prompts training_gen_prompts[]
}

model rule_set_items {
  id              String          @id
  topicId         String
  text            String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  rule_set_topics rule_set_topics @relation(fields: [topicId], references: [id])
}

model rule_set_topics {
  id             String           @id
  rulesetId      String
  name           String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  rule_set_items rule_set_items[]
  rule_sets      rule_sets        @relation(fields: [rulesetId], references: [id])
}

model rule_sets {
  id                   String                 @id
  name                 String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  rule_set_topics      rule_set_topics[]
  training_gen_prompts training_gen_prompts[]
}

model run_crew_announcements {
  id         String    @id @default(cuid())
  runCrewId  String
  authorId   String
  title      String
  content    String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  archivedAt DateTime? @db.Timestamp(6)
  Athlete    Athlete   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  run_crews  run_crews @relation(fields: [runCrewId], references: [id], onDelete: Cascade)
}

model run_crew_event_rsvps {
  id              String          @id @default(cuid())
  eventId         String
  athleteId       String
  status          String
  createdAt       DateTime        @default(now())
  Athlete         Athlete         @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  run_crew_events run_crew_events @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, athleteId])
}

model run_crew_events {
  id                   String                 @id @default(cuid())
  runCrewId            String
  organizerId          String
  title                String
  description          String?
  date                 DateTime
  time                 String
  venue                String // Renamed from location
  address              String?
  cost                 Int? // Cost in dollars (null/0 = free)
  additionalDetails    String? // Any other social details
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  run_crew_event_rsvps run_crew_event_rsvps[]
  Athlete              Athlete                @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  run_crews            run_crews              @relation(fields: [runCrewId], references: [id], onDelete: Cascade)

  @@index([runCrewId])
  @@index([date])
}

model run_crew_memberships {
  id        String      @id @default(cuid())
  runCrewId String
  athleteId String
  joinedAt  DateTime    @default(now())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  role      RunCrewRole @default(member)
  Athlete   Athlete     @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  run_crews run_crews   @relation(fields: [runCrewId], references: [id], onDelete: Cascade)

  @@unique([runCrewId, athleteId])
  @@index([runCrewId, role])
}

model run_crew_messages {
  id        String    @id @default(cuid())
  runCrewId String
  athleteId String
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  topic     String    @default("general")
  Athlete   Athlete   @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  run_crews run_crews @relation(fields: [runCrewId], references: [id], onDelete: Cascade)
}

model run_crew_run_rsvps {
  id        String    @id @default(cuid())
  runId     String
  athleteId String
  status    String
  createdAt DateTime  @default(now())
  Athlete   Athlete   @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  city_runs city_runs @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, athleteId])
}

// Unified model: handles both public city runs and private crew runs
// @deprecated Use `city_runs` model name (table name kept as `run_crew_runs` for backwards compatibility)
model city_runs {
  id                 String               @id @default(cuid())
  citySlug           String // City slug (e.g., "boston", "new-york") - extracted from Google Maps address or user input
  runCrewId          String? // Nullable: null = public city run, set = private crew run (app group)
  runClubSlug        String? // Nullable: official RunClub affiliation (string ref to RunClub.slug in GoFastCompany)
  staffGeneratedId   String? // Nullable: GoFastCompany staff ID (string ref to CompanyStaff.id in GoFastCompany)
  athleteGeneratedId String? // Nullable: Athlete ID (when user-created in gofastapp-mvp)
  title              String
  isRecurring        Boolean              @default(false) // true = standing/recurring run, false = single run
  dayOfWeek          String? // Day of week for recurring runs (e.g., "Monday", "Tuesday", "Wednesday", etc.)
  startDate          DateTime // Start date (for single runs, this is the run date; for recurring, this is when recurrence starts)
  endDate            DateTime? // End date for recurring runs (null = no end date, or end of recurrence period)
  date               DateTime // @deprecated: Use startDate instead (kept for backward compatibility)
  startTimeHour      Int?
  startTimeMinute    Int?
  startTimePeriod    String?
  timezone           String?
  meetUpPoint        String
  meetUpAddress      String? // @deprecated: Use meetUpStreetAddress, meetUpCity, meetUpState instead (kept for backward compatibility)
  meetUpStreetAddress String? // Street address (e.g., "1234 Wilson Blvd")
  meetUpCity          String? // City name (e.g., "Arlington")
  meetUpState         String? // State abbreviation (e.g., "VA")
  meetUpZip           String? // ZIP code (e.g., "22201")
  meetUpPlaceId       String?
  meetUpLat           Float?
  meetUpLng           Float?
  endPoint           String? // Optional end point if different from meet up point
  recurrenceRule     String? // @deprecated: Use isRecurring + dayOfWeek + startDate + endDate instead
  recurrenceEndsOn   DateTime? // @deprecated: Use endDate instead
  recurrenceNote     String?
  totalMiles         Float?
  pace               String?
  stravaMapUrl       String?
  description        String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  run_crew_run_rsvps run_crew_run_rsvps[]
  Athlete            Athlete?             @relation(fields: [athleteGeneratedId], references: [id], onDelete: Cascade)
  run_crews          run_crews?           @relation(fields: [runCrewId], references: [id], onDelete: Cascade)

  @@index([citySlug]) // For querying/filtering by city
  @@index([runCrewId])
  @@index([runClubSlug]) // For querying/filtering by RunClub affiliation
  @@index([staffGeneratedId]) // For querying/filtering by GoFastCompany staff
  @@index([athleteGeneratedId]) // For querying/filtering by user creator
  @@index([date])
  @@index([startDate]) // For querying recurring runs by start date
  @@index([dayOfWeek]) // For querying recurring runs by day of week
  @@index([isRecurring]) // For filtering recurring vs single runs
  @@map("run_crew_runs") // Backwards compatibility: table name remains run_crew_runs
}

// Minimal denormalized copy of AcqRunClub from GoFastCompany
// Pulled and saved via API route for card/run display
// Slug is the source of truth (references GoFastCompany AcqRunClub.slug)
// 
// NOTE: Only minimal fields needed for display (name, logo, city)
// All rich data (vibe, neighborhood, etc.) stays in GoFastCompany for SEO/public pages
model run_clubs {
  slug String @id // Primary key - matches GoFastCompany AcqRunClub.slug

  // Minimal fields for card/run display
  name    String // Run club name
  logoUrl String? // Logo URL for display (from logoUrl or logo field)
  city    String? // City location (for filtering/display)

  // Sync metadata
  syncedAt  DateTime @default(now()) // Last time data was pulled from GoFastCompany
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([city])
  @@map("run_clubs")
}

model run_crews {
  id                      String                    @id @default(cuid())
  handle                  String                    @unique // Public-facing identifier (lowercase, user-chosen)
  name                    String
  description             String?
  joinCode                String                    @unique
  logo                    String?
  icon                    String?
  archivedAt              DateTime?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  messageTopics           Json?
  city                    String?
  easyMilesPace           Int? // Seconds per mile (e.g., 480 for "8:00")
  crushingItPace          Int? // Seconds per mile (e.g., 420 for "7:00")
  ageMin                  Int?
  ageMax                  Int?
  primaryMeetUpPoint      String?
  primaryMeetUpAddress    String?
  primaryMeetUpPlaceId    String?
  primaryMeetUpLat        Float?
  primaryMeetUpLng        Float?
  gender                  Gender?
  state                   State?
  typicalRunMiles         Float?
  longRunMilesMin         Float?
  longRunMilesMax         Float?
  timePreference          TimePreference[]          @default([])
  purpose                 Purpose[]                 @default([])
  trainingForRace         String? // race_registry.id (nullable)
  trainingForDistance     TrainingForDistance[]     @default([])
  join_codes              join_codes[]
  run_crew_specific_races run_crew_specific_races[]
  run_crew_announcements  run_crew_announcements[]
  run_crew_events         run_crew_events[]
  run_crew_memberships    run_crew_memberships[]
  run_crew_messages       run_crew_messages[]
  city_runs               city_runs[]
  race_registry           race_registry?            @relation("TrainingForRace", fields: [trainingForRace], references: [id], onDelete: SetNull)
}

model run_crew_specific_races {
  id             String        @id @default(cuid())
  runCrewId      String
  raceRegistryId String
  createdAt      DateTime      @default(now())
  run_crews      run_crews     @relation(fields: [runCrewId], references: [id], onDelete: Cascade)
  race_registry  race_registry @relation(fields: [raceRegistryId], references: [id], onDelete: Cascade)

  @@unique([runCrewId, raceRegistryId])
}

model training_days_executed {
  id          String   @id
  athleteId   String
  activityId  String?  @unique
  weekIndex   Int
  dayIndex    Int
  date        DateTime
  plannedData Json?
  analysis    Json?
  feedback    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Athlete     Athlete  @relation(fields: [athleteId], references: [id])
}

model training_gen_prompts {
  id                  String                @id
  name                String
  description         String?
  aiRoleId            String
  ruleSetId           String?
  mustHavesId         String
  returnFormatId      String
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  prompt_instructions prompt_instructions[]
  ai_roles            ai_roles              @relation(fields: [aiRoleId], references: [id])
  must_haves          must_haves            @relation(fields: [mustHavesId], references: [id])
  return_json_formats return_json_formats   @relation(fields: [returnFormatId], references: [id])
  rule_sets           rule_sets?            @relation(fields: [ruleSetId], references: [id])
}

model training_plan_phases {
  id                     String                @id
  planId                 String
  name                   String
  weekCount              Int
  totalMiles             Float?
  phaseDescription       String?
  phaseTotalMilesTarget  Float?
  longRunProgression     Int[]                 @default([])
  qualityWorkoutsPerWeek Int                   @default(1)
  runTypesEnabled        Json?
  phaseStartDate         DateTime
  phaseEndDate           DateTime
  createdAt              DateTime              @default(now())
  updatedAt              DateTime
  training_plans         training_plans        @relation(fields: [planId], references: [id], onDelete: Cascade)
  training_plan_weeks    training_plan_weeks[]

  @@unique([planId, name])
}

model training_plan_weeks {
  id                   String               @id
  planId               String
  phaseId              String
  weekNumber           Int
  miles                Float?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime
  planningDays         Json?
  training_plan_phases training_plan_phases @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  training_plans       training_plans       @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, weekNumber])
}

model training_plans {
  id                   String                 @id
  athleteId            String
  raceId               String?
  name                 String
  goalTime             String?
  goalRacePace         Int?
  predictedRacePace    Int?
  current5KPace        String?
  currentWeeklyMileage Int?
  preferredDays        Int[]
  startDate            DateTime
  totalWeeks           Int
  goalPace5K           String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  training_plan_phases training_plan_phases[]
  training_plan_weeks  training_plan_weeks[]
  Athlete              Athlete                @relation(fields: [athleteId], references: [id])
  race_registry        race_registry?         @relation(fields: [raceId], references: [id])
}

model training_schemas {
  id          String   @id
  name        String   @unique
  description String?
  schemaJson  Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

// Workout Model - Coach-authored, reusable workout intent
// This represents intent, not execution data, and does not depend on training_plan_days
model Workout {
  id             String         @id @default(cuid())
  title          String // Required
  workoutType    WorkoutType // Required
  description    String? // Coach notes / intent
  workoutFormat  WorkoutFormat?
  totalMiles     Float?
  warmUpMiles    Float?
  mainSetMiles   Float?
  coolDownMiles  Float?
  effortType     EffortType?
  effortModifier Float? // sec/mi OR RPE
  athleteId      String // FK for authorship and lookup
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId])
  @@index([workoutType])
  @@map("workouts")
}

enum Gender {
  male
  female
  both
}

enum RunCrewRole {
  member
  admin
  manager
}

enum State {
  AL
  AK
  AZ
  AR
  CA
  CO
  CT
  DE
  DC
  FL
  GA
  HI
  ID
  IL
  IN
  IA
  KS
  KY
  LA
  ME
  MD
  MA
  MI
  MN
  MS
  MO
  MT
  NE
  NV
  NH
  NJ
  NM
  NY
  NC
  ND
  OH
  OK
  OR
  PA
  RI
  SC
  SD
  TN
  TX
  UT
  VT
  VA
  WA
  WV
  WI
  WY
}

enum Purpose {
  Training
  Fun
  Social
}

enum TimePreference {
  Morning
  Afternoon
  Evening
}

enum TrainingForDistance {
  FiveK
  TenK
  HalfMarathon
  Marathon
  Ultra
}

enum WorkoutType {
  Easy
  Tempo
  Intervals
  LongRun
  Speed
  Strength
}

enum WorkoutFormat {
  Continuous
  WarmupMainCooldown
  Progression
  IntervalsUnstructured
}

enum EffortType {
  Easy
  MarathonEffort
  HalfMarathonEffort
  TenKEffort
  FiveKEffort
  RPE
}

//
// ─── CITIES (City Reference Model) ────────────────────────────
//
// Cities: Lightweight reference model for GTM and public surfacing
// All runs (both public city runs and private crew runs) belong to a city
//

model cities {
  id        String   @id @default(cuid())
  slug      String   @unique // URL-friendly identifier (e.g., "boston", "new-york")
  name      String // Display name (e.g., "Boston", "New York")
  state     String? // State abbreviation (e.g., "MA", "NY")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Note: city_runs now uses citySlug (string) instead of FK to cities
  // This allows for simpler city handling without requiring city records

  @@index([slug])
  @@index([name])
}
